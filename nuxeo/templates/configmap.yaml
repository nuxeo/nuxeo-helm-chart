apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "nuxeo.fullname" . }}-conf
  labels:
    app: {{ template "nuxeo.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
    role: config
data:
  nuxeo.conf: |-
    # Helm chart properties
    nuxeo.virtual.host={{ .Values.nuxeo.virtualHost  }}
    nuxeo.stream.work.log.codec=avro
    nuxeo.stream.audit.log.codec=avro
    nuxeo.stream.pubsub.log.codec=avro
{{- if .Values.nuxeo.mongodb.enabled }}
    nuxeo.templates=default,mongodb
    nuxeo.mongodb.server={{ .Values.nuxeo.mongodb.protocol }}://{{ required "nuxeo.mongodb.host is required" .Values.nuxeo.mongodb.host }}:{{ .Values.nuxeo.mongodb.port }}
    nuxeo.mongodb.dbname={{ template "nuxeo.fullname" . }}
{{- end }}
{{- if .Values.nuxeo.postgresql.enabled }}
    nuxeo.templates=default,postgresql
    nuxeo.db.host={{ required "nuxeo.postgresql.host is required" .Values.nuxeo.postgresql.host }}
    nuxeo.db.port={{ .Values.nuxeo.postgresql.port }}
    nuxeo.db.name={{ template "nuxeo.fullname" . }}
    nuxeo.db.user={{ .Values.nuxeo.postgresql.username }}
    nuxeo.db.password={{ .Values.nuxeo.postgresql.password }}
{{- end }}
{{- if .Values.nuxeo.elasticsearch.enabled }}
    elasticsearch.addressList={{ .Values.nuxeo.elasticsearch.protocol }}://{{ required "nuxeo.elasticsearch.host is required" .Values.nuxeo.elasticsearch.host }}:{{ .Values.nuxeo.elasticsearch.port }}
    elasticsearch.clusterName={{ .Values.nuxeo.elasticsearch.clusterName }}
    elasticsearch.indexName={{ template "nuxeo.fullname" . }}
    elasticsearch.indexNumberOfReplicas={{ .Values.nuxeo.elasticsearch.indexNumberOfReplicas }}
    elasticsearch.restClient.socketTimeoutMs={{ .Values.nuxeo.elasticsearch.restClient.socketTimeoutMs }}
    elasticsearch.restClient.connectionTimeoutMs={{ .Values.nuxeo.elasticsearch.restClient.connectionTimeoutMs }}
{{- end }}
{{- if .Values.nuxeo.kafka.enabled }}
    kafka.enabled=true
    kafka.bootstrap.servers={{ required "nuxeo.kafka.host is required" .Values.nuxeo.kafka.host }}:{{ .Values.nuxeo.kafka.port }}
    kafka.topicPrefix={{ template "nuxeo.fullname" . }}
    nuxeo.stream.work.enabled=true
    nuxeo.pubsub.provider=stream
{{- end }}
{{- if .Values.nuxeo.redis.enabled }}
{{- if .Values.nuxeo.mongodb.enabled }}
    nuxeo.templates=default,mongodb,redis
{{- else if  .Values.nuxeo.postgresql.enabled }}
    nuxeo.templates=default,postgresql,redis
{{- else }}
    nuxeo.templates=default,redis
{{- end }}
    nuxeo.redis.host={{ .Values.nuxeo.redis.host }}
    nuxeo.work.queuing=redis
    nuxeo.redis.enabled=true
{{- end }}
{{- if .Values.nuxeo.googleCloudStorage.enabled }}
    nuxeo.core.binarymanager=org.nuxeo.ecm.core.storage.gcp.GoogleStorageBinaryManager
    nuxeo.gcp.project={{ .Values.nuxeo.googleCloudStorage.gcpProject }}
    nuxeo.gcp.credentials={{ .Values.nuxeo.googleCloudStorage.credentials }}
    nuxeo.gcp.storage.bucket= {{ .Values.nuxeo.googleCloudStorage.bucket }}
    {{- if .Values.nuxeo.googleCloudStorage.bucketPrefix }}
    nuxeo.gcp.storage.bucket_prefix={{ .Values.nuxeo.googleCloudStorage.bucketPrefix }}
    {{- else }}
    nuxeo.gcp.storage.bucket_prefix={{ template "nuxeo.fullname" . }}/
    {{- end }}
{{- end }}
{{- if .Values.nuxeo.amazonS3.enabled }}
    nuxeo.core.binarymanager=org.nuxeo.ecm.core.storage.sql.S3BinaryManager
    nuxeo.aws.accessKeyId={{ .Values.nuxeo.amazonS3.accessKeyId }}
    nuxeo.aws.secretKey={{ .Values.nuxeo.amazonS3.secretAccessKey }}
    nuxeo.aws.region={{ .Values.nuxeo.amazonS3.region }}
    nuxeo.s3storage.bucket= {{ .Values.nuxeo.amazonS3.bucket }}
    {{- if .Values.amazonS3.nuxeo.bucketPrefix }}
    nuxeo.s3storage.bucket_prefix={{ .Values.amazonS3.nuxeo.bucketPrefix }}
    {{- else }}
    nuxeo.s3storage.bucket_prefix={{ template "nuxeo.fullname" . }}/
    {{- end }}
{{- end }}
{{- if or (gt (int .Values.nuxeo.replicaCount) 1) (include "nuxeo.cloudProvider.enabled" .) }}
    nuxeo.cluster.enabled=true
    nuxeo.cluster.nodeid=${env:POD_UID}
{{- end }}
{{- if .Values.nuxeo.customParams }}
{{ .Values.nuxeo.customParams | indent 4 }}
{{- end }}